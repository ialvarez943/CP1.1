pipeline {
  agent any 

  options {skipDefaultCheckout()}

  stages {
    stage('Get Code') {
      steps {
        git branch: 'develop', url: 'https://github.com/ialvarez943/CP1.1.git'
        stash name: 'code', includes: '**'
      }
    }

    stage('Build') {
      steps {
          echo 'Esto es Python, no hay que compilar nada!'
      }
    }

    stage('Tests') {
      parallel {
        stage('Unit') {
          agent {label 'Agent1'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              bat '''
                export PYTHONPATH=${WORKSPACE}
                /home/agent1/.local/bin/pytest --junitxml=result-unit.xml test/unit
              '''
              stash name: 'unit-res', includes: 'result-unit.xml'
            }
          }
        }

        stage('Rest') {
          agent {label 'Agent2'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              bat '''
                export FLASK_APP=app/api.py                          
                /home/agent2/.local/bin/flask run &
                export PYTHONPATH=${WORKSPACE}
                sleep 15
                /home/agent2/.local/bin/pytest --junitxml=result-rest.xml test/rest
              '''
              stash name: 'rest-res', includes: 'result-rest.xml'
            }
          }
        }
      }
    }
    stage('Results') {
      steps {
        unstash name: 'unit-res'
        unstash name: 'rest-res'

        junit 'result*.xml'
      }
      
    }
  }
}
pipeline {
  agent any 

  options {skipDefaultCheckout()}

  stages {
    stage('Get Code') {
      steps {
        git branch: 'develop', url: 'https://github.com/ialvarez943/CP1.1.git'
        stash name: 'code', includes: '**'
      }
    }

    stage('Static') {
      steps {
        bat '''
          flake8 --exit-zero --format=pylint app >flake8.out
        '''
        recordIssues tools: [flake8(name: 'flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 10, type: 'TOTAL', unstable: true], [threshold: 11, type: 'TOTAL', unstable: false]]
      }
    }

    stage('Tests') {
      parallel {
        stage('Unit') {
          agent {label 'Agent1'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              sh '''
                export PYTHONPATH=${WORKSPACE}
                pytest -q --junitxml=result-unit.xml test/unit
              '''
              stash name: 'unit-res', includes: 'result-unit.xml'
            }
          }
        }

        stage('Rest') {
          agent {label 'Agent2'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              sh '''
                export FLASK_APP=app/api.py                          
                flask run &
                FLASK_PID=$!
                export PYTHONPATH=${WORKSPACE}
                sleep 15
                pytest -q --junitxml=result-rest.xml test/rest
                kill $FLASK_PID
              '''
              stash name: 'rest-res', includes: 'result-rest.xml'
            }
          }
        }
      }
    }
    stage ('Coverage') {
      steps {
        bat '''
          SET PYTHONPATH=%WORKSPACE%
          coverage run --branch --source=app --omit=app\\__init__.py,app\\api.py -m pytest test\\unit
          coverage xml
        '''
        recordCoverage qualityGates: [[criticality: 'ERROR', integerThreshold: 85, metric: 'LINE', threshold: 85.0], [criticality: 'NOTE', integerThreshold: 99, metric: 'MODULE', threshold: 95.0], [criticality: 'NOTE', integerThreshold: 65, metric: 'BRANCH', threshold: 65.0]], tools: [[parser: 'COBERTURA']]
      }
    }

    stage('Security') {
      steps {
        bat '''
          bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
        '''
        recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true], [threshold: 2, type: 'TOTAL', unstable: false]]
      }
    }

    stage('Performance') {
      steps {
        bat '''
          SET PYTHONPATH=%WORKSPACE%
          SET FLASK_APP=app/api.py                          
          start flask run
          ping -n 6 127.0.0.1
          D:\\Proyectos\\ESTUDIOS\\UNIR\\DEVOPS\\PRACTICAS\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -f -l flask.jtl
        '''
        perfReport sourceDataFiles: 'flask.jtl'
      }
    }

    stage('Results') {
      steps {
        unstash name: 'unit-res'
        unstash name: 'rest-res'

        junit 'result*.xml'
      }
      
    }
  }
}
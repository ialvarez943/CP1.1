pipeline {
  agent any 

  options {skipDefaultCheckout()}

  stages {
    stage('Get Code') {
      steps {
        git branch: 'develop', url: 'https://github.com/ialvarez943/CP1.1.git'
        stash name: 'code', includes: '**'
      }
    }

    stage('Build') {
      steps {
          echo 'Esto es Python, no hay que compilar nada!'
      }
    }

    stage('Tests') {
      parallel {
        stage('Unit') {
          agent {label 'Agent1'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              sh '''
                export PYTHONPATH=${WORKSPACE}
                pytest -q --junitxml=result-unit.xml test/unit
              '''
              stash name: 'unit-res', includes: 'result-unit.xml'
            }
          }
        }

        stage('Rest') {
          agent {label 'Agent2'}
          steps {
            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
              unstash name: 'code'
              sh '''
                export FLASK_APP=app/api.py                          
                flask run &
                FLASK_PID=$!
                export PYTHONPATH=${WORKSPACE}
                sleep 15
                pytest -q --junitxml=result-rest.xml test/rest
                kill $FLASK_PID
              '''
              stash name: 'rest-res', includes: 'result-rest.xml'
            }
          }
        }
      }
    }
    stage('Results') {
      steps {
        unstash name: 'unit-res'
        unstash name: 'rest-res'

        junit 'result*.xml'
      }
      
    }
  }
}